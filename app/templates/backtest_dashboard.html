{% extends "base.html" %}

{% block title %}Backtesting Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-6 bg-gray-900 min-h-screen flex">
    <!-- Left Sidebar Form -->
    <div class="w-1/4 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold text-gray-200 mb-4">Backtest Parameters</h2>
        <form id="backtest-form" class="space-y-4">
            <div>
                <label class="block text-gray-400">Ticker</label>
                <input type="text" id="ticker" name="ticker" class="w-full p-2 bg-gray-700 text-white rounded-lg" placeholder="AAPL">
            </div>
            <div>
                <label class="block text-gray-400">Strategy</label>
                <select id="strategy" name="strategy" class="w-full p-2 bg-gray-700 text-white rounded-lg">
                    <option value="moving_average">Moving Average</option>
                    <option value="mean_reversion">Mean Reversion</option>
                    <option value="momentum">Momentum</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-400">Timeframe</label>
                <input type="date" id="timeframe" name="timeframe" max="{{ current_year }}-12-31" class="w-full p-2 bg-gray-700 text-white rounded-lg">
            </div>
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-400 text-white py-2 rounded-lg transition">Start Backtest</button>
        </form>
    </div>

    <!-- Right Hand Chart Section -->
    <div class="w-3/4 ml-6 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold text-gray-200 mb-4">Stock Price Chart</h2>
        <div id="chart-container" class="w-full h-[500px] bg-gray-900 rounded-lg"></div>
        
        <!-- Account Balance -->
        <h2 class="text-xl font-bold text-gray-200 mt-6">Account Balance: <span id="account-balance" class="text-green-400">$10000</span></h2>
        
        <!-- Open Positions Table -->
        <h2 class="text-xl font-bold text-gray-200 mt-4">Current Positions</h2>
        <table class="w-full text-left text-white mt-2">
            <thead>
                <tr>
                    <th class="py-2">Ticker</th>
                    <th class="py-2">Quantity</th>
                    <th class="py-2">P&L</th>
                </tr>
            </thead>
            <tbody id="positions-table">
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    const chartOptions = {
        chart: { type: 'line', height: 500, background: '#1a1a1a' },
        series: [{ name: "Price", data: [] }],
        xaxis: { type: 'datetime', labels: { style: { colors: '#ffffff' } } },
        yaxis: { labels: { style: { colors: '#ffffff' } } },
        theme: { mode: 'dark' }
    };
    const chart = new ApexCharts(document.querySelector("#chart-container"), chartOptions);
    chart.render();

    const ws = new WebSocket("ws://localhost:8000/ws/backtest");
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.price) {
            chart.appendData([{ data: [[data.timestamp, data.price]] }]);
        }
        if (data.balance) {
            document.getElementById("account-balance").textContent = `$${data.balance.toFixed(2)}`;
        }
        if (data.positions) {
            const table = document.getElementById("positions-table");
            table.innerHTML = "";
            data.positions.forEach(position => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="py-2">${position.ticker}</td>
                    <td class="py-2">${position.quantity}</td>
                    <td class="py-2" style="color: ${position.pnl >= 0 ? 'green' : 'red'};">$${position.pnl.toFixed(2)}</td>
                `;
                table.appendChild(row);
            });
        }
    };

    document.getElementById("backtest-form").onsubmit = function(event) {
        event.preventDefault();
        const ticker = document.getElementById("ticker").value;
        const strategy = document.getElementById("strategy").value;
        const timeframe = document.getElementById("timeframe").value;
        ws.send(JSON.stringify({ ticker, strategy, timeframe }));
    };
</script>
{% endblock %}
