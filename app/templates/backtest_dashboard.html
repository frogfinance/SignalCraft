{% extends "base.html" %}

{% block title %}Backtesting Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-6 bg-gray-900 min-h-screen flex">
    <!-- Left Sidebar Form -->
    <div class="w-1/4 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold text-gray-200 mb-4">Backtest Parameters</h2>
        <form id="backtest-form" class="space-y-4">
            <div>
                <label class="block text-gray-400">Ticker</label>
                {% for ticker in tickers %}
                <input type="text" id="ticker-{{ticker}}" name="{{ticker}}" class="w-full p-2 bg-gray-700 text-white rounded-lg" placeholder="AAPL">
                {% endfor %}
            </div>
            <div>
                <label class="block text-gray-400">Strategy</label>
                <select id="strategy" name="strategy" class="w-full p-2 bg-gray-700 text-white rounded-lg">
                    {% for strategy in strategies %}
                    <option value="{{strategy.name}}">{{strategy.display_name}}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-400 text-white py-2 rounded-lg transition">Start Backtest</button>
        </form>
    </div>

    <!-- Right Hand Chart Section -->
    <div class="w-3/4 ml-6 bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold text-gray-200 mb-4">Backtest Chart</h2>
        <div id="chart-container" class="w-full h-[500px] bg-gray-900 rounded-lg"></div>
        
        <!-- Account Balance -->
        <h2 class="text-xl font-bold text-gray-200 mt-6">Account Balance: <span id="account-balance" class="text-green-400">{{ account_info.buying_power or "30000" }}</span></h2>
        
        <!-- Open Positions Table -->
        <h2 class="text-xl font-bold text-gray-200 mt-4">Current Positions</h2>
        <table class="w-full text-left text-white mt-2">
            <thead>
                <tr>
                    <th class="py-2">Ticker</th>
                    <th class="py-2">Quantity</th>
                    <th class="py-2">P&L</th>
                </tr>
            </thead>
            <tbody id="positions-table">
                {% for position in positions %}
                <tr>
                    <td class="py-2">{{ position.ticker }}</td>
                    <td class="py-2">{{ position.quantity }}</td>
                    <td class="py-2" style="color: {{ 'green' if position.pnl >= 0 else 'red' }};">$ {{ position.pnl }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.4.0"></script>
<script>
    const chartContainer = document.getElementById("chart-container");
    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 500,
        layout: {
            backgroundColor: '#1a1a1a',
            textColor: '#ffffff',
        },
        grid: {
            vertLines: { color: '#444' },
            horzLines: { color: '#444' },
        },
        timeScale: { borderColor: '#888' },
        rightPriceScale: { borderColor: '#888' }
    });
    
    const candleSeries = chart.addCandlestickSeries();
    
    const ws = new WebSocket((window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws/backtest");
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.balance) {
            document.getElementById("account-balance").textContent = `$${data.balance.toFixed(2)}`;
        }
        if (data.positions) {
            const table = document.getElementById("positions-table");
            table.innerHTML = "";
            data.positions.forEach(position => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="py-2">${position.ticker}</td>
                    <td class="py-2">${position.quantity}</td>
                    <td class="py-2" style="color: ${position.pnl >= 0 ? 'green' : 'red'};">$${position.pnl.toFixed(2)}</td>
                `;
                table.appendChild(row);
            });
        }
        if (data.ticker_data) {
            const priceData = data.ticker_data.map(entry => ({
                time: entry.timestamp,
                open: entry.open,
                high: entry.high,
                low: entry.low,
                close: entry.close,
            }));
            candleSeries.setData(priceData);
        }
    };
    
    document.getElementById("backtest-form").onsubmit = function(event) {
        event.preventDefault();
        const ticker = document.getElementById("ticker").value;
        const strategy = document.getElementById("strategy").value;
        const timeframe = document.getElementById("timeframe").value;
        ws.send(JSON.stringify({ ticker, strategy, timeframe }));
    };
</script>
{% endblock %}
